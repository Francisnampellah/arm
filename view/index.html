<!DOCTYPE html>
<html>
  <head>
    <script src="https://aframe.io/releases/1.2.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js/aframe/build/aframe-ar.min.js"></script>
    <script src="https://raw.githack.com/fcor/arjs-gestures/master/dist/gestures.js"></script>

  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene embedded vr-mode-ui="enabled: false" arjs="sourceType: webcam; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3;">
      
      <!-- Custom marker disabled until a real .patt file is provided
      -->
      <!-- Example pattern marker using the bundled patterns directory -->
      <a-assets>
        <a-asset-item id="hiro-model" src="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models@master/2.0/Lantern/glTF/Lantern.gltf"></a-asset-item>
      </a-assets>

      <!-- Hiro marker -->
      <a-marker type="barcode" value="1" preset="hiro">
        <a-entity gltf-model="#hiro-model" position="0 0 0" rotation="0 0 0" scale="0.4 0.4 0.4"></a-entity>
      </a-marker>

      <!-- Dynamic barcode markers will be appended here by script -->

      <!-- Camera -->
      <a-entity camera></a-entity>
    </a-scene>
    <script>
      // Debug: log when the Hiro marker is detected or lost and wait for scene load
      document.addEventListener('DOMContentLoaded', function () {
        var scene = document.querySelector('a-scene');
        if (!scene) return;

        // When scene is loaded (A-Frame + AR.js initialized), fetch mappings and add markers
        var addMarkers = function () {
          var hiroMarker = document.querySelector('a-marker[preset="hiro"]');
          if (hiroMarker) {
            hiroMarker.addEventListener('markerFound', function () {
              console.log('Hiro marker found');
            });
            hiroMarker.addEventListener('markerLost', function () {
              console.log('Hiro marker lost');
            });
          }

          // Fetch marker mappings from the server and create pattern markers dynamically
          fetch('/api/mappings')
            .then(function (res) { return res.json(); })
            .then(function (mappings) {
              if (!Array.isArray(mappings)) return;

              mappings.forEach(function (m) {
                var id = Number(m.markerId);
                if (!Number.isFinite(id) || Number.isNaN(id)) return; // skip invalid ids

                var maxPatterns = 64;
                var index = ((id - 1) % maxPatterns + maxPatterns) % maxPatterns; // zero-based
                var pad = String(index).padStart(2, '0');
                var patternUrl = '/markers/patterns/pattern-' + pad + '.patt';

                var marker = document.createElement('a-marker');
                marker.setAttribute('type', 'pattern');
                marker.setAttribute('url', patternUrl);
                marker.setAttribute('emitevents', 'true');

                if (m.modelUrl && typeof m.modelUrl === 'string' && m.modelUrl.trim() !== '') {
                  var entity = document.createElement('a-entity');
                  entity.setAttribute('gltf-model', m.modelUrl);
                  entity.setAttribute('position', '0 0 0');
                  entity.setAttribute('rotation', '0 0 0');
                  entity.setAttribute('scale', '0.5 0.5 0.5');
                  marker.appendChild(entity);
                } else {
                  var placeholder = document.createElement('a-box');
                  placeholder.setAttribute('position', '0 0.5 0');
                  placeholder.setAttribute('color', '#4CC3D9');
                  placeholder.setAttribute('depth', '0.5');
                  placeholder.setAttribute('height', '0.5');
                  placeholder.setAttribute('width', '0.5');
                  marker.appendChild(placeholder);
                }

                if (m.objectName) {
                  var text = document.createElement('a-text');
                  text.setAttribute('value', m.objectName);
                  text.setAttribute('align', 'center');
                  text.setAttribute('position', '0 1 0');
                  text.setAttribute('color', '#FFF');
                  text.setAttribute('wrap-count', '20');
                  marker.appendChild(text);
                }

                scene.appendChild(marker);
              });
            })
            .catch(function (err) { console.error('Failed to load mappings', err); });
        };

        // If the scene is already loaded, add markers; otherwise wait for the 'loaded' event.
        if (scene.hasLoaded) {
          // small delay to let AR.js initialize
          setTimeout(addMarkers, 200);
        } else {
          scene.addEventListener('loaded', function () { setTimeout(addMarkers, 200); });
        }
      });
    </script>
  </body>
</html>


